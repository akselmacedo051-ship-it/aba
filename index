<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Abastecimento Almoxarifado</title>
<style>
body { font-family: Arial, sans-serif; background:#f3f3f3; margin:0; padding:0; }
header { background:#004d40; color:#fff; padding:12px; text-align:center; font-size:1.5em; }
main { max-width:500px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
label { display:block; margin-top:12px; font-weight:bold; }
select, input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:4px; font-size:1em; }
button { margin-top:16px; padding:12px; width:100%; font-size:1em; background:#004d40; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#00695c; }
#reader { width:100%; margin-top:16px; }
.status { margin-top:12px; text-align:center; font-weight:bold; }
.error { color:red; }
.success { color:green; }
</style>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
<header>Abastecimento Almoxarifado</header>
<main>
  <div id="reader"></div>

  <form id="form">
    <label>Item:</label>
    <select id="itemSelect">
      <option value="">-- SELECIONE --</option>
      <option>2002558 CAIXA CAFE 3C EF RN VAC 20X250G</option>
      <option>2002557 CAIXA CAFE 3C TRAD RN VAC 20X250G</option>
      <option>2002545 CAIXA CAFE KIM CE RN VAC 20X250G</option>
      <option>2002547 CAIXA CAFE PRINCIPAL CE RN VAC 20X250G</option>
      <option>2001644 CAIXA CAFE SC CE RN VAC 250G</option>
      <option>2002546 CAIXA CAFE SC PREM CE RN VAC 250G</option>
      <option>2000892 CAIXA CAFE TM SC EF CE/RN 250G</option>
      <option>2005049 EMB CAFE 3C EF TUDO SW GOG CE V2 250G</option>
      <option>2005092 EMB CAFE 3C EF TUDO SW VAC BOSCH V2 250G</option>
      <option>2004365 EMB CAFE 3C TRAD TUDO GOG CE SW VAC 250G</option>
      <option>2003134 EMB CAFE KIM CE RN ALM 100G</option>
      <option>2002363 EMB CAFE KIM CE/RN ALM 250G</option>
      <option>2005008 EMB CAFE KIM TUDO ALM V2 100G</option>
      <option>2005043 EMB CAFE KIM TUDO ALM V2 20X250G</option>
      <option>2004371 EMB CAFE KIM TUDO SW VAC 250G</option>
      <option>2004505 EMB CAFE KIM TUDO SW VAC GOG 250G</option>
      <option>2005037 EMB CAFE KIM TUDO SW VAC GOG V2 250G</option>
      <option>2005070 EMB CAFE KIM TUDO SW VAC V2 250G</option>
      <option>2005015 EMB CAFE PRINC TUDO ALM V2 250G</option>
      <option>2005030 EMB CAFE PRINC TUDO SW VAC GOG V3 250G</option>
      <option>2005016 EMB CAFE PRINC TUDO SW VAC V2 250G</option>
      <option>2003187 EMB CAFE SC CLAS CE RN ALM 100G</option>
      <option>2002564 EMB CAFE SC CLAS CE RN ALM 250G</option>
      <option>2001261 EMB CAFE SC CLAS CE SW VAC 250G</option>
      <option>2002055 EMB CAFE SC CLAS SW VAC GOG 250G</option>
      <option>2004779 EMB CAFE SC CLAS SW VAC GOG V2 20X250G</option>
      <option>2004483 EMB CAFE SC CLAS TUDO ALM 100G</option>
      <option>2004560 EMB CAFE SC CLAS TUDO ALM 250G</option>
      <option>2004405 EMB CAFE SC CLAS TUDO SW VAC 250G</option>
      <option>2004504 EMB CAFE SC CLAS TUDO SW VAC GOG 250G</option>
      <option>2005120 EMB CAFE SC EF CE SW PKD TUDO V2 250G</option>
      <option>2005086 EMB CAFE SC EF TUDO SW GOG CE V2 250G</option>
      <option>2003633 EMB CAFE SC PREM DW VAC 250G</option>
      <option>2004301 EMB CAFE SC PREM DW VAC V2 250G</option>
      <option>2001020 EMB CAFE TM 3 FAZENDAS TRAD VAC GOG 250G</option>
      <option>2004442 EMB CAFE TM 3C TRAD TUDO BOSCH VAC 250G</option>
      <option>2005071 EMB CAFE TM SC EF TUDO ALM FABR V2 250G</option>
      <option>2005076 EMB CAFE TM SC EF TUDO ALM V2 100G</option>
      <option>2005391 EMB CAFE TM SC PREM SW VAC GOG V2 250G</option>
      <option>2004774 EMB CAFE TM SC PREM SW VAC V2 250G</option>
      <option>2003060 FILME ENF PE CAFE KIM 100G</option>
      <option>2003061 FILME ENF PE CAFE KIM 250G</option>
      <option>2003653 FILME ENF PE CAFE PRINCIPAL 250G</option>
      <option>2001641 FILME ENF PE CAFE SC CLAS 100G</option>
      <option>2001642 FILME ENF PE CAFE SC CLAS 250G</option>
      <option>2000886 FILME ENFAR PET CAFE TM SC EF 20X250G</option>
      <option>2000716 FILME ENFAR PET CAFE TM SC EF 50X100G</option>
    </select>

    <label>Quantidade:</label>
    <input type="number" id="quantidade" placeholder="Informe a quantidade" min="1">

    <label>Lote:</label>
    <input type="text" id="lote" placeholder="Informe o lote">

    <button type="button" id="registrarBtn">Registrar</button>
    <div id="status" class="status"></div>
  </form>
</main>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwFnSXdHYgYfOnbTNE2JmO_a9G1ZTBcxCdVxo5Aq3M75jE_lfz21kqUpjkDdrtFhfWRHQ/exec"; // Cole aqui a URL do Apps Script

const itemSelect = document.getElementById('itemSelect');
const quantidadeInput = document.getElementById('quantidade');
const loteInput = document.getElementById('lote');
const status = document.getElementById('status');
const registrarBtn = document.getElementById('registrarBtn');

async function enviarRegistro(item, quantidade, lote, qrcode=''){
  const data = {item, quantidade, lote, qrcode};
  try {
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if(result.status === "success"){
      status.textContent="Registrado com sucesso!";
      status.className="status success";
      quantidadeInput.value='';
      loteInput.value='';
      itemSelect.selectedIndex=0;
    } else {
      status.textContent="Erro ao registrar!";
      status.className="status error";
    }
  } catch(e){
    console.error(e);
    status.textContent="Erro de conexão!";
    status.className="status error";
  }
}

registrarBtn.addEventListener('click',()=>{
  if(!itemSelect.value || !quantidadeInput.value || !loteInput.value){
    status.textContent="Preencha todos os campos!";
    status.className="status error";
    return;
  }
  enviarRegistro(itemSelect.value, quantidadeInput.value, loteInput.value);
});

// QR Code Scanner
function interpretarQR(text){
  text = text.trim().toUpperCase();
  if(/^Q:/i.test(text)) return {type:'quant', value:text.replace(/^Q:/i,'')};
  if(/^L:/i.test(text)) return {type:'lote', value:text.replace(/^L:/i,'')};
  if(/^\d+/.test(text)){
    for(const opt of itemSelect.options){
      if(opt.value.startsWith(text)) return {type:'item', value:opt.value};
    }
  }
  return {type:'lote', value:text};
}

function processQR(decodedText){
  const result = interpretarQR(decodedText);
  if(result.type==='item') itemSelect.value=result.value;
  else if(result.type==='quant') quantidadeInput.value=result.value;
  else if(result.type==='lote') loteInput.value=result.value;

  if(itemSelect.value && quantidadeInput.value && loteInput.value)
    enviarRegistro(itemSelect.value, quantidadeInput.value, loteInput.value, decodedText);
}

const html5QrCode = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(cameras=>{
  if(cameras.length>0) html5QrCode.start(cameras[0].id,{fps:8, qrbox:250},decodedText=>processQR(decodedText));
  else {status.textContent="Nenhuma câmera encontrada"; status.className="status error";}
}).catch(err=>{status.textContent="Erro câmera"; status.className="status error"; console.error(err);});
</script>
</body>
</html>
